{% extends "../base.njk" %}

{% block skiplinks %}
	<a class="skip scroll pa1 inbl smaller print-hidden" href="#content">Aller au contenu</a>
	<a class="skip scroll pa1 inbl smaller print-hidden" href="#sommaire">Aller au sommaire</a>
{% endblock %}

{% block content %}
	<article role="article" itemscope itemtype="https://schema.org/{% if format === 'status' %}Book{% else %}Article{% endif %}">
		<time class="screen-reader-text" datetime="{{ date }}" itemprop="datePublished">{{ date | date }}</time>
		{% if format === 'status' %}
			<aside class="book mb2">
				<dl class="small ul-reset">
					{%- if auteur !== "" %}
						<div>
							<dt>Auteur(s) :&nbsp;</dt>
							<dd itemprop="author">{{ auteur }}</dd>
						</div>
					{%- endif -%}
					{%- if editeur !== "" %}
						<div>
							<dt>Éditeur(s) :&nbsp;</dt>
							<dd itemprop="publisher">{{ editeur }}</dd>
						</div>
					{%- endif -%}
					{%- if collection !== "" %}
						<div>
							<dt>Collection :&nbsp;</dt>
							<dd itemprop="bookEdition">{{ collection }}</dd>
						</div>
					{%- endif -%}
					{%- if lien !== "" %}
						<div>
							<dt>Lien :&nbsp;</dt>
							<dd>
								<a href="{{ lien }}" itemprop="url">Sur le site de l’éditeur</a>
							</dd>
						</div>
					{%- endif -%}
					{%- if date_de_parution !== "" %}
						<div>
							<dt>Date de parution :&nbsp;</dt>
							<dd itemprop="datePublished"><time datetime="{{ date_de_parution | publicationdate }}">{{ date_de_parution }}</time></dd>
						</div>
					{%- endif -%}
					{%- if ean13 !== "" %}
						<div>
							<dt><abbr title="European Article Numbering" lang="en">EAN</abbr>13 :&nbsp;</dt>
							<dd itemprop="isbn">{{ ean13 }}</dd>
						</div>
					{%- endif -%}
					{%- if nombre_de_pages !== "" %}
						<div>
							<dt>Nombre de pages :&nbsp;</dt>
							<dd itemprop="numberOfPages">{{ nombre_de_pages }} pages</dd>
						</div>
					{%- endif -%}
					{%- if note !== "" %}
						<div itemprop="review" itemscope itemtype="https://schema.org/Review">
							<dt>Note :&nbsp;</dt>
							<dd itemprop="reviewRating" itemscope itemtype="https://schema.org/Rating">
								<meta content="0" itemprop="worstRating">
								<meta content="{{ note }}" itemprop="ratingValue">
								<meta content="5" itemprop="bestRating">
								<span aria-label="{{ note }} sur 5" title="{{ note }} sur 5">
									{%- for i in range(0, note) %}★{% endfor -%}
									{%- for i in range(note, 5) %}☆{% endfor -%}
								</span>
							</dd>
						</div>
					{%- endif -%}
				</dl>
			</aside>
			<div itemprop="review" itemscope itemtype="https://schema.org/Review">
				<div itemprop="reviewBody">
					{{ content | safe }}
				</div>
			</div>
		{% elseif format === 'quote' %}
			<blockquote class="description pb1 pt2" itemprop="description"{% if lang !== "" %} lang="{{ lang }}"{% endif %}>
				<p class="m-reset">{{ excerpt | markdown | safe }}</p>
				<footer class="small ml2">{{ title | safe }}</footer>
			</blockquote>
		{% else %}
			<div itemprop="articleBody">
				{{ content | safe }}
			</div>
		{% endif %}
		<footer class="small mt2">
			<p class="pl2 mt0 pt1">
				Article rédigé par <strong itemprop="author"><span class="fn">{{ site.author.name }}</span></strong>.
				Modifié le <time class="updated" datetime="{{ modified or date }}" itemprop="dateModified">{{ modified | date or date | date }}</time>.
			</p>
		</footer>
	</article>
{% endblock %}

{% block comments %}
	{%- set slug = permalink | replace("/index.html", "") -%}
	{%- set comments = collections.comments | comments(slug) -%}
	{%- set commentsNumber = comments | length -%}
	{%- if commentsOpen === 'true' or commentsNumber > 0 -%}
		<div id="comments" class="comments-area pl2 pt2 mt2 print-hidden">
			{%- if commentsNumber > 0 -%}
				<h2 class="comments-title" itemprop="interactionCount" content="UserComments:{{ commentsNumber }}">
					{{ commentsNumber }} commentaire{%- if commentsNumber > 1 -%}s{%- endif %} sur
					<span class="tk-bello-pro h2-like" itemprop="discusses">«&nbsp;{{ title | safe }}&nbsp;»</span>
					<a href="#sommaire" class="scroll small" title="Retour au sommaire">⤴</a>
				</h2>
				<ol class="commentlist ul-reset pl0" itemprop="comment">
					{%- for comment in comments -%}
						<li id="{{ comment.data.id }}" class="mb2" itemscope itemtype="https://schema.org/UserComments">
							<article>
								<header>
									{%- if comment.data.author_avatar !== "" -%}
										<img alt="" loading="lazy"
												 src="{{ comment.data.author_avatar }}?s=44&d=mm&r=g"
												 srcset="{{ comment.data.author_avatar }}?s=88&d=mm&r=g 2x"
												 class="avatar avatar-44 photo"
												 height="44" width="44">
									{%- endif -%}
									<em itemprop="creator" class="pl1">
										{%- if comment.data.author_url !== "" -%}
											<a href="{{ comment.data.author_url }}" class="url" rel="ugc external nofollow">{{ comment.data.author_name }}</a>
										{%- elseif site.author.name === comment.data.author_name -%}
											{{ comment.data.author_name }} <small>(Rédacteur)</small>
										{%- else -%}
											{{ comment.data.author_name }}
										{%- endif -%}
									</em>
									{% set date = comment.data.date | datetime %}
									<time datetime="{{ comment.data }}" itemprop="commentTime">{{ date | replace(':', ' h ')}} min</time>
									<a href="#{{ comment.data.id }}">
										<span class="screen-reader-text">Ancre vers ce commentaire</span>
										<span aria-hidden="true">⚓</span>
									</a>
								</header>
							</article>
							<div itemprop="CommentText">{{ comment.content | safe }}</div>
						</li>
					{%- endfor -%}
				</ol>
			{%- endif -%}

			{%- if commentsOpen === 'true' -%}
				{%- set commentID_1 = [1,2,3,4,5,6,7,8,9] | random -%}
				{%- set commentID_2 = [1,2,3,4,5,6,7,8,9] | random -%}
				{%- set commentID_3 = [1,2,3,4,5,6,7,8,9] | random -%}
				{%- set commentID_4 = [1,2,3,4,5,6,7,8,9] | random -%}
				{%- set commentID = [commentID_1,commentID_2,commentID_3,commentID_4] | join -%}
				<div class="comment-respond">
					<h3>Laisser un commentaire</h3>
					<form action="https://github.com/ffoodd/ffoodd.fr/new/main/src/posts/{{ slug }}/comments/new?value=&filename={{ commentID }}.md" method="post" class="comment-form">
						<p class="comment-notes">
							Vous devez avoir un compte GitHub pour ajouter un commentaire.
						</p>
						<p>
							<label for="pseudo">Pseudonyme GitHub <span class="required">(obligatoire)</span></label>
							<input id="pseudo" name="pseudo" type="text"
										 aria-required="true" required="required" autocomplete="nickname">
						</p>
						<p>
							<label for="comment">Commentaire <span class="required">(obligatoire)</span></label>
							<textarea id="comment" name="comment" cols="45" rows="8"
												aria-required="true" required="required" aria-describedby="comment-note"></textarea>
							<span id="comment-note" class="small">Markdown accepté.</span>
						</p>
						<p class="form-submit">
							<input name="submit" type="submit" id="submit" class="submit" value="Laisser un commentaire">
						</p>
					</form>
					<script>
						const form = document.querySelector('.comment-form');

						form.addEventListener('submit', async (event) => {
							event.preventDefault();
							const pseudo = document.getElementById('pseudo').value;
							const comment = document.getElementById('comment').value;

							const content = await fetch(`https://api.github.com/users/${pseudo}`)
								.then(response => response.json())
								.then(user => {
									const content = encodeURIComponent(`---
date: "${new Date().toISOString()}"
author_name: "${user.name}"
author_url: "${user.blog}"
author_avatar: "${user.avatar_url}"
id: "{{ commentID }}"
tags: ["comments","{{ slug }}"]
---
${comment}`);

									window.open(`https://github.com/ffoodd/ffoodd.fr/new/main/_src/posts/{{ slug }}/comments/?value=${content}&filename={{ commentID }}.md`)
								});
						});
					</script>
				{%- endif -%}
			</div>
		{%- endif -%}
{% endblock %}

{% block aside %}
	{%- set slug = permalink | replace("/index.html", "") -%}
	{%- set comments = collections.comments | comments(slug) -%}
	{%- set commentsNumber = comments | length -%}
	<aside class="col pt8 pl0 pr0 print-hidden" role="complementary" id="sommaire">
		<div class="aside pl2 pt2">
			<h3 class="tk-bello-pro h2-like m-reset">Sommaire</h3>
			<div class="textwidget">
				{{ content | toc | replace('</ol>', '') | safe }}
					{%- if commentsNumber > 0 -%}
						<li><a href="#comments">Commentaires</a></li>
					{%- endif -%}
				</ol>
			</div>
		</div>
	</aside>
{% endblock %}
